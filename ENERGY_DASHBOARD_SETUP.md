# Setting Up Home Assistant Energy Dashboard with SolArk

## Overview

With version 5.0.0+, the SolArk Cloud integration is fully compatible with Home Assistant's Energy dashboard. You can track solar production, grid consumption, battery usage, and home consumption all in one place.

## What Gets Tracked

The Energy dashboard can track:
- âœ… **Solar Production** - Energy generated by your panels
- âœ… **Grid Consumption** - Energy imported from the grid
- âœ… **Grid Return** - Energy exported to the grid  
- âœ… **Home Consumption** - Total energy used by your home
- âœ… **Battery** - Energy charged and discharged

## Prerequisites

1. **Integration installed** - SolArk Cloud integration v5.0.0 or newer
2. **Sensors working** - Verify sensors show data in Developer Tools â†’ States
3. **Energy dashboard enabled** - Home Assistant 2021.8.0 or newer (Energy dashboard is built-in)

## Step-by-Step Setup

### Step 1: Access Energy Dashboard Configuration

1. Go to **Settings** â†’ **Dashboards** â†’ **Energy**
2. Or click **Energy** in the sidebar (if visible)
3. Click **Add Energy Configuration** (first time) or the **gear icon** (if already configured)

### Step 2: Configure Solar Production

1. In the Energy Configuration, find **Solar panels**
2. Click **ADD SOLAR PRODUCTION**
3. Select: `sensor.solark_energy_total`
4. Click **SAVE**

**Why this sensor?**
- `sensor.solark_energy_total` is a cumulative counter (TOTAL_INCREASING)
- Home Assistant calculates daily/monthly production from this
- This tracks your total lifetime solar production

### Step 3: Configure Grid Consumption

**Option A: Using Individual Import/Export (Recommended if you export to grid)**

1. Find **Grid consumption** section
2. Click **ADD CONSUMPTION**
3. Under **Energy consumed from the grid**, this requires an energy sensor (kWh), not power
4. **Problem:** Your integration currently only provides power sensors (W)
5. **Solution:** Create Riemann Sum helpers (see below)

**Option B: Using Net Grid Power (Simple, but less accurate)**

If you don't export to grid, you can use the net grid sensor with a Riemann Sum helper.

### Step 4: Create Energy Helpers (Required)

Since your integration provides power (W) but Energy dashboard needs energy (kWh), create Riemann Sum integration helpers:

#### 4a. Grid Import Energy Helper

1. Go to **Settings** â†’ **Devices & Services** â†’ **Helpers**
2. Click **+ CREATE HELPER**
3. Select **Riemann sum integral**
4. Configure:
   - **Input sensor**: `sensor.solark_grid_import_power`
   - **Name**: `Grid Import Energy`
   - **Integration method**: `Trapezoidal rule`
   - **Metric prefix**: `k` (kilo)
   - **Time unit**: `Hours`
   - **Round to decimals**: `3`
5. Click **CREATE**

This creates: `sensor.grid_import_energy` (in kWh)

#### 4b. Grid Export Energy Helper

1. Create another Riemann sum helper
2. Configure:
   - **Input sensor**: `sensor.solark_grid_export_power`
   - **Name**: `Grid Export Energy`
   - **Integration method**: `Trapezoidal rule`
   - **Metric prefix**: `k` (kilo)
   - **Time unit**: `Hours`
   - **Round to decimals**: `3`
3. Click **CREATE**

This creates: `sensor.grid_export_energy` (in kWh)

#### 4c. Home Consumption Energy Helper (Optional but Recommended)

1. Create another Riemann sum helper
2. Configure:
   - **Input sensor**: `sensor.solark_load_power`
   - **Name**: `Home Consumption Energy`
   - **Integration method**: `Trapezoidal rule`
   - **Metric prefix**: `k` (kilo)
   - **Time unit**: `Hours`
   - **Round to decimals**: `3`
3. Click **CREATE**

This creates: `sensor.home_consumption_energy` (in kWh)

### Step 5: Configure Grid in Energy Dashboard

Now go back to **Energy Configuration**:

1. Under **Grid consumption**, click **ADD CONSUMPTION**
2. **Energy consumed from the grid**: Select `sensor.grid_import_energy`
3. Under **Grid production** (if you have net metering):
   - Click **ADD RETURN**
   - Select `sensor.grid_export_energy`
4. Click **SAVE**

### Step 6: Configure Home Battery (Optional)

If you want to track battery energy flow:

#### 6a. Create Battery Energy Helpers

**Battery Discharge Energy:**
1. Create Riemann sum helper
2. Input: Create a template sensor first (see below)
3. Or skip battery tracking for now (it's complex)

**Note:** Battery energy tracking is more complex because you need to separate charge vs discharge. This requires template sensors to split the battery_power into positive (discharge) and negative (charge) components first.

### Step 7: Verify Configuration

1. Wait 1-2 hours for data to accumulate
2. Go to **Energy** dashboard
3. You should see:
   - Solar production graph
   - Grid consumption/export
   - Home consumption (if configured)

## Advanced: Battery Energy Tracking

To properly track battery energy, you need to create template sensors that split charge/discharge:

### Create Template Sensors

Add to your `configuration.yaml`:

```yaml
template:
  - sensor:
      # Battery Discharge Power (only positive values)
      - name: "Battery Discharge Power"
        unique_id: battery_discharge_power
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set power = states('sensor.solark_battery_power') | float(0) %}
          {{ max(0, power) }}
      
      # Battery Charge Power (only negative values, converted to positive)
      - name: "Battery Charge Power"
        unique_id: battery_charge_power
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set power = states('sensor.solark_battery_power') | float(0) %}
          {{ max(0, -power) }}
```

Then create Riemann Sum helpers for each:
1. `sensor.battery_discharge_energy` (from `sensor.battery_discharge_power`)
2. `sensor.battery_charge_energy` (from `sensor.battery_charge_power`)

Finally, add to Energy dashboard:
- Battery systems â†’ ADD BATTERY SYSTEM
- Energy going in: `sensor.battery_charge_energy`
- Energy going out: `sensor.battery_discharge_energy`

## Troubleshooting

### "Sensor not available" in Energy Dashboard

**Cause:** Energy dashboard only accepts sensors with `state_class: TOTAL_INCREASING` or `TOTAL` for cumulative counters.

**Solution:** 
- Use `sensor.solark_energy_total` for solar (it has the correct state_class)
- Use Riemann Sum helpers for powerâ†’energy conversion

### "Statistics not available"

**Cause:** New sensors need time to build up statistics (usually 1-2 hours).

**Solution:** Wait and check back later. Home Assistant builds statistics in the background.

### Graphs Show Flat Lines

**Cause:** No data variation yet, or sensor not updating.

**Solutions:**
1. Verify sensor updates: Developer Tools â†’ States â†’ Check sensor timestamps
2. Wait for solar production (during daylight hours)
3. Check integration is working: Settings â†’ Devices & Services â†’ SolArk Cloud

### Energy Values Seem Wrong

**Causes:**
- Riemann Sum helpers created recently (they start from zero)
- Integration was offline/unavailable during periods
- Power sensor reporting incorrect values

**Solutions:**
1. Give it 24 hours to accumulate accurate data
2. Check power sensors show reasonable values
3. Verify integration scan interval isn't too slow (30s recommended)

### Reset Energy Statistics

If you need to start fresh:

1. Go to **Developer Tools** â†’ **Statistics**
2. Find your energy sensors
3. Click **Fix Issue** â†’ **Delete All Statistics**
4. Confirm deletion
5. Statistics will rebuild from current time forward

## What You Can Do with Energy Dashboard

Once configured, you can:

- âœ… Track daily/monthly/yearly solar production
- âœ… Monitor grid import vs export
- âœ… Calculate self-consumption percentage
- âœ… View energy flow diagrams
- âœ… Track costs (if you add electricity rates)
- âœ… Compare time periods
- âœ… Export data for analysis

## Adding Electricity Costs (Optional)

To track costs:

1. Go to Energy Configuration
2. Under **Grid consumption**, click the **pencil icon** next to your grid sensor
3. Check **Use an entity tracking the total costs**
4. You can either:
   - Enter a **fixed price per kWh**
   - Or select a **sensor** that tracks your electricity rate

Home Assistant will then show cost calculations in the Energy dashboard.

## Energy Dashboard vs. Your Custom Dashboard

**Energy Dashboard** (Settings â†’ Dashboards â†’ Energy):
- Built into Home Assistant
- Automatic graphs and statistics
- Shows cumulative energy over time (kWh)
- Best for long-term tracking and cost analysis

**Your SolArk Custom Dashboard** (`dashboards/solark_flow.yaml`):
- Real-time power monitoring (W)
- Instant power flow visualization
- Live status indicators
- Best for moment-to-moment monitoring

**Use Both!** They complement each other:
- Custom dashboard for "What's happening right now?"
- Energy dashboard for "How much energy this month?"

## Example Complete Configuration

Here's a complete configuration.yaml section for full energy tracking:

```yaml
# Template sensors for battery split
template:
  - sensor:
      - name: "Battery Discharge Power"
        unique_id: battery_discharge_power
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set power = states('sensor.solark_battery_power') | float(0) %}
          {{ max(0, power) }}
      
      - name: "Battery Charge Power"
        unique_id: battery_charge_power
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set power = states('sensor.solark_battery_power') | float(0) %}
          {{ max(0, -power) }}
```

Then create these Riemann Sum helpers via UI:
1. Grid Import Energy (from solark_grid_import_power)
2. Grid Export Energy (from solark_grid_export_power)
3. Battery Discharge Energy (from battery_discharge_power template)
4. Battery Charge Energy (from battery_charge_power template)
5. Home Consumption Energy (from solark_load_power)

Finally configure Energy dashboard:
- **Solar**: sensor.solark_energy_total
- **Grid Import**: sensor.grid_import_energy
- **Grid Export**: sensor.grid_export_energy
- **Battery In**: sensor.battery_charge_energy
- **Battery Out**: sensor.battery_discharge_energy

## Summary

Your SolArk Cloud integration is now fully Energy dashboard compatible! The key requirements are:

1. âœ… Energy sensors have `state_class: TOTAL_INCREASING` (done in v5.0.0+)
2. âœ… Power sensors have `state_class: MEASUREMENT` (done in v5.0.0+)
3. âœ… Create Riemann Sum helpers to convert power (W) to energy (kWh)
4. âœ… Configure Energy dashboard with your sensors

After setup, you'll have comprehensive energy tracking showing exactly where your energy comes from and goes to! ðŸŒžðŸ”‹âš¡
